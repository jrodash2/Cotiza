{% extends 'almacen/base.html' %}
{% load static %}

{% block content %}
<div class="form-page-wrap">
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0">{% if cotizacion %}Editar{% else %}Nueva{% endif %} cotización</h5>
      <a class="btn btn-light" href="{% url 'cotizaciones:cotizacion_list' %}">Volver</a>
    </div>
    <div class="card-body">
      <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="accordion" id="cotizacionFormAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="cotizacionHeadingEncabezado">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cotizacionSectionEncabezado" aria-expanded="true" aria-controls="cotizacionSectionEncabezado">
                Encabezado
              </button>
            </h2>
            <div id="cotizacionSectionEncabezado" class="accordion-collapse collapse show" aria-labelledby="cotizacionHeadingEncabezado" data-bs-parent="#cotizacionFormAccordion">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label">Cliente</label>
                    {{ form.cliente }}
                    {{ form.cliente.errors }}
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label">Fecha emisión</label>
                    {{ form.fecha_emision }}
                    {{ form.fecha_emision.errors }}
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label">Estado</label>
                    {{ form.estado }}
                    {{ form.estado.errors }}
                  </div>
                  <div class="col-12">
                    <label class="form-label">Título</label>
                    {{ form.titulo }}
                    {{ form.titulo.errors }}
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label">Validez (días)</label>
                    {{ form.validez_dias }}
                    {{ form.validez_dias.errors }}
                  </div>
                  <div class="col-12 col-md-9">
                    <label class="form-label">Garantía</label>
                    {{ form.garantia_texto }}
                    {{ form.garantia_texto.errors }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="cotizacionHeadingItems">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cotizacionSectionItems" aria-expanded="false" aria-controls="cotizacionSectionItems">
                Detalle / Ítems
              </button>
            </h2>
            <div id="cotizacionSectionItems" class="accordion-collapse collapse" aria-labelledby="cotizacionHeadingItems" data-bs-parent="#cotizacionFormAccordion">
              <div class="accordion-body">
                {% if formset.non_form_errors %}
                  <div class="alert alert-danger">
                    {{ formset.non_form_errors }}
                  </div>
                {% endif %}
                <div class="d-flex justify-content-end mb-3">
                  <button type="button" class="btn btn-primary btn-sm" id="add-item-btn">+ Agregar ítem</button>
                </div>
                {{ formset.management_form }}
                <div class="table-responsive">
                  <table class="table table-sm table-bordered align-middle" id="items-table">
                    <thead class="table-light">
                      <tr>
                        <th style="min-width: 240px;">Producto/Servicio</th>
                        <th style="width: 140px;">Cantidad</th>
                        <th style="width: 160px;">Precio</th>
                        <th style="width: 160px;">Subtotal</th>
                        <th style="width: 140px;">Acciones</th>
                      </tr>
                    </thead>
                    <tbody data-formset-prefix="{{ formset.prefix }}" data-price-url="{% url 'cotizaciones:producto_precio' 0 %}">
                      {% for item_form in formset %}
                        <tr class="item-form">
                          <td>
                            {{ item_form.producto_servicio }}
                            {{ item_form.producto_servicio.errors }}
                          </td>
                          <td>
                            {{ item_form.cantidad }}
                            {{ item_form.cantidad.errors }}
                          </td>
                          <td class="text-nowrap">
                            <span class="js-precio">
                              Q {{ item_form.instance.precio_venta_unitario|default_if_none:"0.00"|floatformat:2 }}
                            </span>
                          </td>
                          <td class="text-nowrap">
                            <span class="js-subtotal">
                              Q {{ item_form.instance.total_linea_venta|default_if_none:"0.00"|floatformat:2 }}
                            </span>
                          </td>
                          <td>
                            {% if formset.can_delete %}
                              <span class="d-none">{{ item_form.DELETE }}</span>
                              <button type="button" class="btn btn-outline-danger btn-sm js-remove">Eliminar</button>
                            {% endif %}
                          </td>
                          {% for hidden in item_form.hidden_fields %}
                            {{ hidden }}
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <template id="item-row-template">
                  <tr class="item-form">
                    <td>{{ formset.empty_form.producto_servicio }}</td>
                    <td>{{ formset.empty_form.cantidad }}</td>
                    <td class="text-nowrap"><span class="js-precio">Q 0.00</span></td>
                    <td class="text-nowrap"><span class="js-subtotal">Q 0.00</span></td>
                    <td>
                      {% if formset.can_delete %}
                        <span class="d-none">{{ formset.empty_form.DELETE }}</span>
                        <button type="button" class="btn btn-outline-danger btn-sm js-remove">Eliminar</button>
                      {% endif %}
                    </td>
                    {% for hidden in formset.empty_form.hidden_fields %}
                      {{ hidden }}
                    {% endfor %}
                  </tr>
                </template>
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h2 class="accordion-header" id="cotizacionHeadingObservaciones">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cotizacionSectionObservaciones" aria-expanded="false" aria-controls="cotizacionSectionObservaciones">
                Observaciones
              </button>
            </h2>
            <div id="cotizacionSectionObservaciones" class="accordion-collapse collapse" aria-labelledby="cotizacionHeadingObservaciones" data-bs-parent="#cotizacionFormAccordion">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label">Observaciones</label>
                    {{ form.observaciones }}
                    {{ form.observaciones.errors }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2 justify-content-end mt-4">
          <a class="btn btn-light" href="{% url 'cotizaciones:cotizacion_list' %}">Cancelar</a>
          <button class="btn btn-primary" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tableBody = document.querySelector('#items-table tbody');
    const addButton = document.getElementById('add-item-btn');
    const template = document.getElementById('item-row-template');
    if (!tableBody || !addButton || !template) {
      return;
    }

    const formsetPrefix = tableBody.dataset.formsetPrefix;
    const totalFormsInput = document.querySelector(`input[name="${formsetPrefix}-TOTAL_FORMS"]`);
    const priceUrlTemplate = tableBody.dataset.priceUrl;

    const buildPriceUrl = (productId) => priceUrlTemplate.replace('0/', `${productId}/`);

    const parsePrice = (value) => {
      const cleaned = value.replace('Q', '').replace(',', '').trim();
      const parsed = Number.parseFloat(cleaned);
      return Number.isNaN(parsed) ? 0 : parsed;
    };

    const updateSubtotal = (row, price) => {
      const qtyInput = row.querySelector('input[name$="-cantidad"]');
      const subtotalSpan = row.querySelector('.js-subtotal');
      const quantity = Number.parseFloat(qtyInput?.value || '0');
      const subtotal = (Number.isNaN(quantity) ? 0 : quantity) * price;
      subtotalSpan.textContent = `Q ${subtotal.toFixed(2)}`;
    };

    const updateRowPrice = (row) => {
      const productSelect = row.querySelector('select[name$="-producto_servicio"]');
      const priceSpan = row.querySelector('.js-precio');
      if (!productSelect || !priceSpan) {
        return;
      }
      const productId = productSelect.value;
      if (!productId) {
        priceSpan.textContent = 'Q 0.00';
        updateSubtotal(row, 0);
        return;
      }
      fetch(buildPriceUrl(productId))
        .then((response) => (response.ok ? response.json() : Promise.reject()))
        .then((data) => {
          const price = Number.parseFloat(data.precio_venta || '0');
          const safePrice = Number.isNaN(price) ? 0 : price;
          priceSpan.textContent = `Q ${safePrice.toFixed(2)}`;
          updateSubtotal(row, safePrice);
        })
        .catch(() => {
          priceSpan.textContent = 'Q 0.00';
          updateSubtotal(row, 0);
        });
    };

    const reindexForms = () => {
      const rows = Array.from(tableBody.querySelectorAll('.item-form'));
      rows.forEach((row, index) => {
        const elements = row.querySelectorAll('input, select, textarea, label');
        elements.forEach((element) => {
          if (element.name) {
            element.name = element.name.replace(
              new RegExp(`${formsetPrefix}-\\d+-`),
              `${formsetPrefix}-${index}-`,
            );
          }
          if (element.id) {
            element.id = element.id.replace(
              new RegExp(`id_${formsetPrefix}-\\d+-`),
              `id_${formsetPrefix}-${index}-`,
            );
          }
          if (element.htmlFor) {
            element.htmlFor = element.htmlFor.replace(
              new RegExp(`id_${formsetPrefix}-\\d+-`),
              `id_${formsetPrefix}-${index}-`,
            );
          }
        });
      });
      if (totalFormsInput) {
        totalFormsInput.value = rows.length;
      }
    };

    const bindRow = (row) => {
      const productSelect = row.querySelector('select[name$="-producto_servicio"]');
      const qtyInput = row.querySelector('input[name$="-cantidad"]');
      const removeBtn = row.querySelector('.js-remove');

      if (productSelect) {
        productSelect.addEventListener('change', () => updateRowPrice(row));
      }
      if (qtyInput) {
        qtyInput.addEventListener('input', () => {
          const priceSpan = row.querySelector('.js-precio');
          const price = priceSpan ? parsePrice(priceSpan.textContent) : 0;
          updateSubtotal(row, price);
        });
      }
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          const deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
          const idInput = row.querySelector('input[name$="-id"]');
          if (deleteInput && idInput && idInput.value) {
            deleteInput.checked = true;
            row.classList.add('d-none');
            return;
          }
          row.remove();
          reindexForms();
        });
      }
    };

    const addRow = () => {
      if (!totalFormsInput) {
        return;
      }
      const formIndex = parseInt(totalFormsInput.value, 10);
      const html = template.innerHTML.replace(/__prefix__/g, formIndex);
      const tempWrapper = document.createElement('tbody');
      tempWrapper.innerHTML = html.trim();
      const newRow = tempWrapper.querySelector('tr');
      if (!newRow) {
        return;
      }
      tableBody.appendChild(newRow);
      totalFormsInput.value = formIndex + 1;
      bindRow(newRow);
    };

    addButton.addEventListener('click', addRow);
    Array.from(tableBody.querySelectorAll('.item-form')).forEach((row) => {
      bindRow(row);
      updateRowPrice(row);
    });
  });
</script>
{% endblock %}
